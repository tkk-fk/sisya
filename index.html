<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>視写プリントメーカー（不可視文字対策／縦書き／自動改ページ）</title>

<!-- 教科書体のフォールバック（端末に教科書体が無い場合用） -->
<link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@500;700&display=swap" rel="stylesheet" />

<style>
  :root{
    --cell: 52px;     /* マス一辺 */
    --line:#60bdfc;   /* グリッド線 */
    --frame:#60bdfc;  /* 用紙外枠 */
    --thin:1px;       /* 画面表示の線幅 */
    --maxw: 1120px;   /* ページの最大幅 */
    --gap: 16px;      /* 左右シート間のすきま */

    /* 教科書体優先 → Klee One → Noto Serif JP → 明朝系 */
    --font-kyokasho:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B",
      "Yu Kyokasho","YuKyokasho",
      "Hiragino Kyoiku","HGS教科書体","HG教科書体",
      "Klee One","Noto Serif JP",
      "Hiragino Mincho ProN","Yu Mincho","MS Mincho",serif;
  }

  *{ box-sizing:border-box }
  body{
    margin:0; background:#fff; color:#111;
    font-family: var(--font-kyokasho);
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }

  /* ─ UI ─ */
  header{
    max-width:var(--maxw);
    margin:16px auto 12px; padding:0 12px;
    display:grid; gap:10px;
  }
  textarea{
    width:100%; height:120px; resize:vertical;
    padding:10px; font-size:16px; line-height:1.6;
    border:1px solid #e5e7eb; border-radius:10px;
    font-family: var(--font-kyokasho);
  }
  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .ctrl{ display:flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:999px; padding:8px 12px }
  input[type="range"]{ width:220px }
  input[type="number"]{ width:84px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px }
  button{ border:0; border-radius:12px; padding:10px 16px; font-size:16px; color:#fff; background:#2563eb; cursor:pointer }
  button.print{ background:#0ea5e9 }

  /* ─ ページ（自動複製） ─ */
  main#pages{ display:block }
  .page{
    max-width:var(--maxw);
    margin:0 auto 24px; padding:0 12px;
    display:grid; grid-template-columns:1fr 1fr; gap:var(--gap);
    break-inside: avoid; page-break-inside: avoid;
  }
  .page:not(:last-child){ break-after: page; page-break-after: always; }

  /* ─ シート ─ */
  .sheet{
    border:3px solid var(--frame);
    border-radius:10px;
    padding:10px; /* JS の列上限計算で使用 */
  }
  .title{ text-align:center; font-weight:700; margin-bottom:8px }

  /* ─ グリッド領域（右寄せ） ─ */
  .gridArea{
    position:relative;
    margin-left:auto;         /* 右づめ */
    border-radius:4px; overflow:hidden;
  }
  /* SVG グリッド：背景ではないので確実に印刷される */
  .gridSVG{
    position:absolute; inset:0;
    width:100%; height:100%; display:block; pointer-events:none;
  }
  .gridSVG path{
    stroke: var(--line);
    stroke-width: var(--thin);
    fill:none; shape-rendering:crispEdges;
  }

  /* 縦書き列（右→左に増える） */
  .cols{ position:relative; display:flex; flex-direction:row-reverse; align-items:flex-start }
  .col { display:flex; flex-direction:column }

  /* 1マス（縦組みの約物対応） */
  .cell{
    width:var(--cell); height:var(--cell);
    display:flex; align-items:center; justify-content:center;
    font-size:calc(var(--cell) * 0.56);
    line-height:1;
    background:transparent; color:#111;
    font-family: var(--font-kyokasho);

    writing-mode: vertical-rl;      /* 縦書き */
    text-orientation: mixed;        /* 和文は縦用字形、ASCII は回転 */
    font-feature-settings: "vert" 1, "vkna" 1; /* 保険で縦組み機能を明示 */
  }

  @media print{
    @page { size: A4; margin: 10mm; }
    header{ display:none }
    .page{ padding:0; max-width:none; gap:var(--gap) }
    .gridSVG path{ stroke-width:.6px } /* 細線が飛ばないよう微増 */
  }
</style>
</head>
<body>
  <header>
    <textarea id="text" placeholder="文章を入力（空白は空マス／改行は改段）"></textarea>
    <div class="controls">
      <span class="ctrl">マス
        <input type="range" id="size" min="36" max="88" value="52">
        <b id="sizeVal">52px</b>
      </span>
      <span class="ctrl">1列の行数
        <input type="number" id="rows" min="6" max="30" value="12">
      </span>
      <button id="make">作成</button>
      <button class="print" onclick="window.print()">印刷</button>
    </div>
  </header>

  <main id="pages"></main>

<script>
const $ = s => document.querySelector(s);
const root = document.documentElement;
const pagesEl = $('#pages');
const sizeEl=$('#size'), sizeVal=$('#sizeVal'), rowsEl=$('#rows'), textEl=$('#text');

sizeEl.addEventListener('input', ()=>{
  root.style.setProperty('--cell', sizeEl.value+'px');
  sizeVal.textContent = sizeEl.value+'px';
});
$('#make').addEventListener('click', render);

/* 不可視文字・特殊スペースを徹底クリーンアップしてから流し込む */
function sanitizeInput(raw){
  // 1) 正規化（濁点の合成揺れなどを統一）
  let s = (raw || '').normalize('NFC');

  // 2) 改行は LF に統一、タブはスペースへ
  s = s.replace(/\r\n?/g, '\n').replace(/\t/g, ' ');

  // 3) すべての「スペース区分」を半角スペースに統一（全角スペース含む）
  //    \p{Zs} = Space_Separator
  s = s.replace(/\p{Zs}|\u3000/gu, ' ');

  // 4) 制御文字(Cc)・書式文字(Cf)は削除（ただし改行は残す）
  s = s.replace(/[\p{Cc}\p{Cf}]/gu, ch => (ch === '\n' ? '\n' : ''));

  // 5) バリアントセレクタを削除（VS1–16 / IVS：U+E0100–U+E01EF）
  s = s.replace(/[\uFE00-\uFE0F]|\u{E0100}-\u{E01EF}/gu, '');

  // 6) 残存する結合記号（ダイアクリティカルマーク等）は念のため削除
  s = s.replace(/\p{M}+/gu, '');

  return s;
}

/* グラフェム単位に分割（絵文字・合字も1文字扱い） */
function toGraphemes(s){
  if (typeof Intl !== 'undefined' && Intl.Segmenter){
    const seg = new Intl.Segmenter('ja', {granularity:'grapheme'});
    return Array.from(seg.segment(s), x=>x.segment);
  }
  return Array.from(s);
}

/* ページ DOM を生成 */
function newPage(){
  const page = document.createElement('section');
  page.className = 'page';

  const sheetL = document.createElement('section');
  sheetL.className = 'sheet';
  sheetL.innerHTML = `
    <div class="title">お手本</div>
    <div class="gridArea">
      <svg class="gridSVG" aria-hidden="true"></svg>
      <div class="cols"></div>
    </div>`;

  const sheetR = document.createElement('section');
  sheetR.className = 'sheet';
  sheetR.innerHTML = `
    <div class="title">うつす</div>
    <div class="gridArea">
      <svg class="gridSVG" aria-hidden="true"></svg>
      <div class="cols"></div>
    </div>`;

  page.appendChild(sheetL);
  page.appendChild(sheetR);
  pagesEl.appendChild(page);

  const leftArea  = sheetL.querySelector('.gridArea');
  const rightArea = sheetR.querySelector('.gridArea');
  const leftCols  = leftArea.querySelector('.cols');
  const rightCols = rightArea.querySelector('.cols');
  const leftSVG   = leftArea.querySelector('.gridSVG');
  const rightSVG  = rightArea.querySelector('.gridSVG');

  // 1ページに収まる最大列数（シート幅から算出）
  const sheetWidth = sheetL.clientWidth;
  const cs = getComputedStyle(sheetL);
  const pad = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
  const cell = parseFloat(getComputedStyle(root).getPropertyValue('--cell')) || 52;
  const colsCap = Math.max(1, Math.floor((sheetWidth - pad) / cell));

  return { page, leftArea, rightArea, leftCols, rightCols, leftSVG, rightSVG, colsCap, cols:0 };
}

function makeCol(){ const d=document.createElement('div'); d.className='col'; return d; }
function makeCell(text=''){ const d=document.createElement('div'); d.className='cell'; d.textContent=text; return d; }
const isDisplaySpace = ch => ch === ' ';

/* SVG にグリッド線を描画（背景に依存しない） */
function drawGrid(svg, cols, rows, cell){
  const w = cols * cell, h = rows * cell;
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('width', w);
  svg.setAttribute('height', h);
  let d = '';
  for (let x=0; x<=w; x+=cell){ d += `M${x} 0V${h}`; }
  for (let y=0; y<=h; y+=cell){ d += `M0 ${y}H${w}`; }
  let path = svg.querySelector('path');
  if(!path){ path = document.createElementNS('http://www.w3.org/2000/svg','path'); svg.appendChild(path); }
  path.setAttribute('d', d);
}

function render(){
  pagesEl.innerHTML = '';

  const cell = parseFloat(getComputedStyle(root).getPropertyValue('--cell')) || 52;
  const rows = Math.max(1, parseInt(rowsEl.value || '12', 10));

  // 入力をクリーンアップ → 改行は残す（改行＝改段）
  const sanitized = sanitizeInput(textEl.value);
  const units = toGraphemes(sanitized);

  let page = newPage();
  page.leftArea.style.height  = page.rightArea.style.height = (rows * cell) + 'px';

  let r = 0;                      // 現在の行（0..rows-1）
  let colL = null, colR = null;

  function openColumn(){
    // 現在のページでこれ以上置けない → 新しいページ
    if (page.cols >= page.colsCap){
      page = newPage();
      page.leftArea.style.height  = page.rightArea.style.height = (rows * cell) + 'px';
      r = 0;
    }
    colL = makeCol(); colR = makeCol();
    page.leftCols.appendChild(colL);
    page.rightCols.appendChild(colR);
    page.cols++;

    const w = (page.cols * cell) + 'px';
    page.leftArea.style.width  = w;
    page.rightArea.style.width = w;

    drawGrid(page.leftSVG,  page.cols, rows, cell);
    drawGrid(page.rightSVG, page.cols, rows, cell);
  }

  openColumn(); // 最初の列

  for(const u of units){
    if(u === '\n'){               // 改行 → 次の列へ
      r = 0; openColumn();
      continue;
    }
    colL.appendChild(makeCell(isDisplaySpace(u) ? '' : u));  // スペースは空マス表示
    colR.appendChild(makeCell(''));                          // 右は空マス
    r++;
    if(r >= rows){ r = 0; openColumn(); }
  }
}

// 初期表示
root.style.setProperty('--cell', sizeEl.value + 'px');
sizeVal.textContent = sizeEl.value + 'px';
render();
</script>
</body>
</html>
