<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>è¦–å†™ãƒ—ãƒªãƒ³ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆä¸å¯è¦–æ–‡å­—å¯¾ç­–ï¼ç¸¦æ›¸ãï¼è‡ªå‹•æ”¹ãƒšãƒ¼ã‚¸ï¼åˆ©ãæ‰‹å¯¾å¿œï¼‰</title>

<!-- æ•™ç§‘æ›¸ä½“ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç«¯æœ«ã«æ•™ç§‘æ›¸ä½“ãŒç„¡ã„å ´åˆç”¨ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@500;700&display=swap" rel="stylesheet" />

<style>
  :root{
    --cell: 52px;     /* ãƒã‚¹ä¸€è¾º */
    --line:#60bdfc;   /* ã‚°ãƒªãƒƒãƒ‰ç·š */
    --frame:#60bdfc;  /* ç”¨ç´™å¤–æ  */
    --thin:1px;       /* ç”»é¢è¡¨ç¤ºã®ç·šå¹… */
    --maxw: 1120px;   /* ãƒšãƒ¼ã‚¸ã®æœ€å¤§å¹… */
    --gap: 16px;      /* å·¦å³ã‚·ãƒ¼ãƒˆé–“ã®ã™ãã¾ */

    /* æ•™ç§‘æ›¸ä½“å„ªå…ˆ â†’ Klee One â†’ Noto Serif JP â†’ æ˜æœç³» */
    --font-kyokasho:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B",
      "Yu Kyokasho","YuKyokasho",
      "Hiragino Kyoiku","HGSæ•™ç§‘æ›¸ä½“","HGæ•™ç§‘æ›¸ä½“",
      "Klee One","Noto Serif JP",
      "Hiragino Mincho ProN","Yu Mincho","MS Mincho",serif;
  }

  *{ box-sizing:border-box }
  body{
    margin:0; background:#fff; color:#111;
    font-family: var(--font-kyokasho);
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }

  /* â”€ UI â”€ */
  header{
    max-width:var(--maxw);
    margin:16px auto 12px; padding:0 12px;
    display:grid; gap:10px;
  }
  textarea{
    width:100%; height:120px; resize:vertical;
    padding:10px; font-size:16px; line-height:1.6;
    border:1px solid #e5e7eb; border-radius:10px;
    font-family: var(--font-kyokasho);
  }
  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .ctrl{ display:flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:999px; padding:8px 12px }
  .ctrl label{ display:inline-flex; align-items:center; gap:4px; cursor:pointer }
  input[type="range"]{ width:220px }
  input[type="number"]{ width:84px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px }
  button{ border:0; border-radius:12px; padding:10px 16px; font-size:16px; color:#fff; background:#2563eb; cursor:pointer }
  button.print{ background:#0ea5e9 }

  /* â”€ ãƒšãƒ¼ã‚¸ï¼ˆè‡ªå‹•è¤‡è£½ï¼‰ â”€ */
  main#pages{ display:block }
  .page{
    max-width:var(--maxw);
    margin:0 auto 24px; padding:0 12px;
    display:grid; grid-template-columns:1fr 1fr; gap:var(--gap);
    break-inside: avoid; page-break-inside: avoid;
  }
  .page:not(:last-child){ break-after: page; page-break-after: always; }

  /* â”€ ã‚·ãƒ¼ãƒˆ â”€ */
  .sheet{
    border:3px solid var(--frame);
    border-radius:10px;
    padding:10px; /* JS ã®åˆ—ä¸Šé™è¨ˆç®—ã§ä½¿ç”¨ */
  }
  .title{ text-align:center; font-weight:700; margin-bottom:8px }

  /* â”€ ã‚°ãƒªãƒƒãƒ‰é ˜åŸŸï¼ˆå³å¯„ã›ï¼‰ â”€ */
  .gridArea{
    position:relative;
    margin-left:auto;         /* å³ã¥ã‚ */
    border-radius:4px; overflow:hidden; /* ã“ã“ã§ã‚¯ãƒªãƒƒãƒ—ã•ã‚Œã‚‹ãŸã‚ã€SVGå´ã§å¤–æ ç·šãŒæ¬ ã‘ãªã„ã‚ˆã†ã«èª¿æ•´ */
  }
  /* SVG ã‚°ãƒªãƒƒãƒ‰ï¼šèƒŒæ™¯ã§ã¯ãªã„ã®ã§ç¢ºå®Ÿã«å°åˆ·ã•ã‚Œã‚‹ */
  .gridSVG{
    position:absolute; inset:0;
    width:100%; height:100%; display:block; pointer-events:none;
  }
  .gridSVG path{
    stroke: var(--line);
    stroke-width: var(--thin);
    fill:none; shape-rendering:crispEdges;
    vector-effect: non-scaling-stroke; /* å°åˆ·æ™‚ã®æ‹¡å¤§ç¸®å°ã§ã‚‚ç·šå¹…ã‚’ä¿ã¤ */
  }

  /* ç¸¦æ›¸ãåˆ—ï¼ˆå³â†’å·¦ã«å¢—ãˆã‚‹ï¼‰ */
  .cols{ position:relative; display:flex; flex-direction:row-reverse; align-items:flex-start }
  .col { display:flex; flex-direction:column }

  /* 1ãƒã‚¹ï¼ˆç¸¦çµ„ã¿ã®ç´„ç‰©å¯¾å¿œï¼‰ */
  .cell{
    width:var(--cell); height:var(--cell);
    display:flex; align-items:center; justify-content:center;
    font-size:calc(var(--cell) * 0.56);
    line-height:1;
    background:transparent; color:#111;
    font-family: var(--font-kyokasho);

    writing-mode: vertical-rl;      /* ç¸¦æ›¸ã */
    text-orientation: mixed;        /* å’Œæ–‡ã¯ç¸¦ç”¨å­—å½¢ã€ASCII ã¯å›è»¢ */
    font-feature-settings: "vert" 1, "vkna" 1; /* ä¿é™ºã§ç¸¦çµ„ã¿æ©Ÿèƒ½ã‚’æ˜ç¤º */
  }

  @media print{
    @page { size: A4; margin: 10mm; }
    header{ display:none }
    .page{ padding:0; max-width:none; gap:var(--gap) }
    .gridSVG path{ stroke-width:.6px } /* ç´°ç·šãŒé£›ã°ãªã„ã‚ˆã†å¾®å¢— */
  }
</style>
</head>
<body>
  <header>
    <textarea id="text" placeholder="æ–‡ç« ã‚’å…¥åŠ›ï¼ˆç©ºç™½ã¯ç©ºãƒã‚¹ï¼æ”¹è¡Œã¯æ”¹æ®µï¼‰"></textarea>
    <div class="controls">
      <span class="ctrl">ãƒã‚¹
        <input type="range" id="size" min="36" max="88" value="52">
        <b id="sizeVal">52px</b>
      </span>
      <span class="ctrl">1åˆ—ã®è¡Œæ•°
        <input type="number" id="rows" min="6" max="30" value="12">
      </span>
      <span class="ctrl">åˆ©ãæ‰‹
        <label><input type="radio" name="hand" value="right" checked>å³åˆ©ã</label>
        <label><input type="radio" name="hand" value="left">å·¦åˆ©ã</label>
      </span>
      <button id="make">ä½œæˆ</button>
      <button class="print" onclick="window.print()">å°åˆ·</button>
    </div>
  </header>

  <main id="pages"></main>

<script>
/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $ = s => document.querySelector(s);
const root = document.documentElement;
const pagesEl = $('#pages');
const sizeEl=$('#size'), sizeVal=$('#sizeVal'), rowsEl=$('#rows'), textEl=$('#text');

sizeEl.addEventListener('input', ()=>{
  root.style.setProperty('--cell', sizeEl.value+'px');
  sizeVal.textContent = sizeEl.value+'px';
});
$('#make').addEventListener('click', render);

document.querySelectorAll('input[name="hand"]').forEach(el=>{
  el.addEventListener('change', render);
});

function currentHand(){
  const el = document.querySelector('input[name="hand"]:checked');
  return el ? el.value : 'right';
}

/* ä¸å¯è¦–æ–‡å­—ãƒ»ç‰¹æ®Šã‚¹ãƒšãƒ¼ã‚¹ã‚’å¾¹åº•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰æµã—è¾¼ã‚€ */
function sanitizeInput(raw){
  // 1) æ­£è¦åŒ–ï¼ˆæ¿ç‚¹ã®åˆæˆæºã‚Œãªã©ã‚’çµ±ä¸€ï¼‰
  let s = (raw || '').normalize('NFC');

  // 2) æ”¹è¡Œã¯ LF ã«çµ±ä¸€ã€ã‚¿ãƒ–ã¯ã‚¹ãƒšãƒ¼ã‚¹ã¸
  s = s.replace(/\r\n?/g, '\n').replace(/\t/g, ' ');

  // 3) ã™ã¹ã¦ã®ã€Œã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ†ã€ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã«çµ±ä¸€ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€ï¼‰
  //    \p{Zs} = Space_Separator
  s = s.replace(/\p{Zs}|\u3000/gu, ' ');

  // 4) åˆ¶å¾¡æ–‡å­—(Cc)ãƒ»æ›¸å¼æ–‡å­—(Cf)ã¯å‰Šé™¤ï¼ˆãŸã ã—æ”¹è¡Œã¯æ®‹ã™ï¼‰
  s = s.replace(/[\p{Cc}\p{Cf}]/gu, ch => (ch === '\n' ? '\n' : ''));

  // 5) ãƒãƒªã‚¢ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã‚’å‰Šé™¤ï¼ˆVS1â€“16 / IVSï¼šU+E0100â€“U+E01EFï¼‰
  s = s.replace(/[\uFE00-\uFE0F]|[\u{E0100}-\u{E01EF}]/gu, '');

  // 6) æ®‹å­˜ã™ã‚‹çµåˆè¨˜å·ï¼ˆãƒ€ã‚¤ã‚¢ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒãƒ¼ã‚¯ç­‰ï¼‰ã¯å¿µã®ãŸã‚å‰Šé™¤
  s = s.replace(/\p{M}+/gu, '');

  return s;
}

/* ã‚°ãƒ©ãƒ•ã‚§ãƒ å˜ä½ã«åˆ†å‰²ï¼ˆçµµæ–‡å­—ãƒ»åˆå­—ã‚‚1æ–‡å­—æ‰±ã„ï¼‰ */
function toGraphemes(s){
  if (typeof Intl !== 'undefined' && Intl.Segmenter){
    const seg = new Intl.Segmenter('ja', {granularity:'grapheme'});
    return Array.from(seg.segment(s), x=>x.segment);
  }
  return Array.from(s);
}

/* â”€â”€ DOMç”Ÿæˆãƒ˜ãƒ«ãƒ‘ â”€â”€ */
function makeSheet(title){
  const sec=document.createElement('section');
  sec.className='sheet';
  sec.innerHTML = `
    <div class="title">${title}</div>
    <div class="gridArea">
      <svg class="gridSVG" aria-hidden="true"></svg>
      <div class="cols"></div>
    </div>`;
  return sec;
}

/* ãƒšãƒ¼ã‚¸ DOM ã‚’ç”Ÿæˆï¼ˆhand: 'right' | 'left'ï¼‰*/
function newPage(hand){
  const page = document.createElement('section');
  page.className = 'page';

  const leftTitle  = hand === 'left'  ? 'ã†ã¤ã™' : 'ãŠæ‰‹æœ¬';
  const rightTitle = hand === 'left'  ? 'ãŠæ‰‹æœ¬' : 'ã†ã¤ã™';

  const leftSheet  = makeSheet(leftTitle);
  const rightSheet = makeSheet(rightTitle);
  page.appendChild(leftSheet);
  page.appendChild(rightSheet);
  pagesEl.appendChild(page);

  const leftArea  = leftSheet.querySelector('.gridArea');
  const rightArea = rightSheet.querySelector('.gridArea');
  const leftCols  = leftArea.querySelector('.cols');
  const rightCols = rightArea.querySelector('.cols');
  const leftSVG   = leftArea.querySelector('.gridSVG');
  const rightSVG  = rightArea.querySelector('.gridSVG');

  // 1ãƒšãƒ¼ã‚¸ã«åã¾ã‚‹æœ€å¤§åˆ—æ•°ï¼ˆå·¦ã‚·ãƒ¼ãƒˆå¹…ã‹ã‚‰ç®—å‡ºï¼‰
  const sheetWidth = leftSheet.clientWidth;
  const cs = getComputedStyle(leftSheet);
  const pad = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
  const cell = parseFloat(getComputedStyle(root).getPropertyValue('--cell')) || 52;
  const colsCap = Math.max(1, Math.floor((sheetWidth - pad) / cell));

  // ãŠæ‰‹æœ¬ï¼ˆmodelï¼‰å´ã¨ã€ã†ã¤ã™ï¼ˆcopyï¼‰å´ã‚’æ±ºã‚ã‚‹
  const modelIsLeft = (leftTitle === 'ãŠæ‰‹æœ¬');
  const modelArea = modelIsLeft ? leftArea : rightArea;
  const copyArea  = modelIsLeft ? rightArea : leftArea;
  const modelCols = modelIsLeft ? leftCols : rightCols;
  const copyCols  = modelIsLeft ? rightCols : leftCols;
  const modelSVG  = modelIsLeft ? leftSVG  : rightSVG;
  const copySVG   = modelIsLeft ? rightSVG : leftSVG;

  return { page, hand, leftArea, rightArea, leftCols, rightCols, leftSVG, rightSVG,
           modelArea, copyArea, modelCols, copyCols, modelSVG, copySVG,
           colsCap, cols:0 };
}

function makeCol(){ const d=document.createElement('div'); d.className='col'; return d; }
function makeCell(text=''){ const d=document.createElement('div'); d.className='cell'; d.textContent=text; return d; }
const isDisplaySpace = ch => ch === ' ';

/* SVG ã«ã‚°ãƒªãƒƒãƒ‰ç·šã‚’æç”»ï¼ˆèƒŒæ™¯ã«ä¾å­˜ã—ãªã„ï¼‰ */
function drawGrid(svg, cols, rows, cell){
  const w = Math.round(cols * cell), h = Math.round(rows * cell);

  // â–¼å¤–æ ã®ç·šãŒã‚¯ãƒªãƒƒãƒ—ã•ã‚Œãªã„ã‚ˆã†ã«ã€viewBoxã‚’ä¸Šä¸‹å·¦å³ã«0.5pxãšã¤åºƒã’ã‚‹
  const half = 0.5;
  svg.setAttribute('viewBox', `${-half} ${-half} ${w + 1} ${h + 1}`);
  svg.setAttribute('width', w);
  svg.setAttribute('height', h);

  let d = '';
  for (let x=0; x<=w; x+=cell){ d += `M${x} 0V${h}`; }
  for (let y=0; y<=h; y+=cell){ d += `M0 ${y}H${w}`; }
  let path = svg.querySelector('path');
  if(!path){ path = document.createElementNS('http://www.w3.org/2000/svg','path'); svg.appendChild(path); }
  path.setAttribute('d', d);
}

/* ===== ãƒ¡ã‚¤ãƒ³æç”» ===== */
function render(){
  pagesEl.innerHTML = '';

  const cell = parseFloat(getComputedStyle(root).getPropertyValue('--cell')) || 52;
  const rows = Math.max(1, parseInt(rowsEl.value || '12', 10));
  const hand = currentHand();

  // å…¥åŠ›ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— â†’ æ”¹è¡Œã¯æ®‹ã™ï¼ˆæ”¹è¡Œï¼æ”¹æ®µï¼‰
  const sanitized = sanitizeInput(textEl.value);
  const units = toGraphemes(sanitized);

  let page = newPage(hand);
  page.modelArea.style.height = page.copyArea.style.height = (rows * cell) + 'px';

  let r = 0;                      // ç¾åœ¨ã®è¡Œï¼ˆ0..rows-1ï¼‰
  let colModel = null, colCopy = null;

  function openColumn(){
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§ã“ã‚Œä»¥ä¸Šç½®ã‘ãªã„ â†’ æ–°ã—ã„ãƒšãƒ¼ã‚¸
    if (page.cols >= page.colsCap){
      page = newPage(hand);
      page.modelArea.style.height = page.copyArea.style.height = (rows * cell) + 'px';
      r = 0;
    }
    colModel = makeCol(); colCopy = makeCol();
    page.modelCols.appendChild(colModel);
    page.copyCols.appendChild(colCopy);
    page.cols++;

    const w = (page.cols * cell) + 'px';
    page.modelArea.style.width = w;
    page.copyArea.style.width  = w;

    drawGrid(page.modelSVG, page.cols, rows, cell);
    drawGrid(page.copySVG,  page.cols, rows, cell);
  }

  openColumn(); // æœ€åˆã®åˆ—

  for(const u of units){
    if(u === '\n'){               // æ”¹è¡Œ â†’ æ¬¡ã®åˆ—ã¸
      r = 0; openColumn();
      continue;
    }
    page.modelCols.lastElementChild.appendChild(makeCell(isDisplaySpace(u) ? '' : u));  // ãŠæ‰‹æœ¬å´ã«æ–‡å­—
    page.copyCols.lastElementChild.appendChild(makeCell(''));                            // ã†ã¤ã™å´ã¯ç©ºãƒã‚¹
    r++;
    if(r >= rows){ r = 0; openColumn(); }
  }
}

// åˆæœŸè¡¨ç¤º
root.style.setProperty('--cell', sizeEl.value + 'px');
sizeVal.textContent = sizeEl.value + 'px';
render();

/* ===== è‡ªå‹•ãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ï¼‰ =====
   ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«çµæœã‚’å‡ºåŠ›ã—ã¾ã™ã€‚UIã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ */
(function runSelfTests(){
  const results = [];
  function assert(name, cond){ results.push({name, pass: !!cond}); }

  // sanitize: å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ãƒ»Nbspãƒ»åˆ¶å¾¡æ–‡å­—ãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨
  const raw = 'ã‚\u00A0ã„ã€€ã†\tãˆ\r\nãŠ';
  const s = sanitizeInput(raw);
  assert('sanitize replaces all spaces with half-width', !(/[\u00A0\u3000]/.test(s)));
  assert('sanitize keeps newlines', /\n/.test(s));

  // graphemes: çµµæ–‡å­—ã‚’å£Šã•ãªã„
  const emo = 'ğŸ‘¨\u200DğŸ‘©\u200DğŸ‘¦';
  const gs = toGraphemes(emo);
  assert('grapheme segmentation preserves string', gs.join('') === emo);

  // newPage ãŒå¿…è¦ã‚­ãƒ¼ã‚’è¿”ã™
  const tmp = newPage('right');
  assert('newPage returns colsCap >= 1', tmp.colsCap >= 1);

  // render ãŒä¾‹å¤–ã‚’æŠ•ã’ãªã„ï¼ˆå³/å·¦ï¼‰
  try { render(); assert('render() right-hand no throw', true); } catch(e){ assert('render() right-hand threw', false); }
  document.querySelector('input[name="hand"][value="left"]').checked = true;
  try { render(); assert('render() left-hand no throw', true); } catch(e){ assert('render() left-hand threw', false); }
  document.querySelector('input[name="hand"][value="right"]').checked = true; // æˆ»ã™

  // çµæœè¡¨ç¤º
  const ok = results.every(r=>r.pass);
  console.groupCollapsed(`è‡ªå‹•ãƒ†ã‚¹ãƒˆ: ${ok ? 'ALL PASS' : 'SOME FAIL'}`);
  results.forEach(r=> console[r.pass ? 'log' : 'error'](`${r.pass ? 'âœ…' : 'âŒ'} ${r.name}`));
  console.groupEnd();
})();
</script>
</body>
</html>
